<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>回転詩</title>
<style>
  body {
    margin: 0; 
    font-family: serif; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    height: 100vh; 
    background: #fdfdfd;
  }
  #poem-container {
    position: relative; 
    width: 80vw; 
    max-width: 400px; 
    height: 5em; 
    overflow: hidden;
  }
  .line {
    position: absolute;
    width: 100%;
    text-align: center;
    font-size: 2em;
    opacity: 0;
    transition: opacity 0.7s ease;
  }
  .line.active {
    opacity: 1;
  }
</style>
</head>
<body>

<div id="poem-container">
  <!-- JSでここに文章を入れていく -->
</div>

<script>
  const lines = [
    "僕の心に",
    "新たな決意を",
    "握りしめた",
    "小さく震える手を",
    "ふって、ぼくは歩き出すことにした",
    "一緒に居た笑顔の君を",
    "まちつづけたぼく。ずっと",
    "幸せをねがって",
    "バカみたいだ",
    "もう一度君に会いたい。",
    "届かない思い。"
  ];

  const container = document.getElementById('poem-container');
  let currentIndex = 0;

  // 文章をDOMに作る
  lines.forEach((text, i) => {
    const div = document.createElement('div');
    div.classList.add('line');
    if(i === 0) div.classList.add('active');
    div.textContent = text;
    container.appendChild(div);
  });

  const lineElements = container.querySelectorAll('.line');

  // 回転角度に応じて行を切り替える関数
  function updateLineByRotation(angle) {
    // angleを0-360に正規化
    let normAngle = angle % 360;
    if (normAngle < 0) normAngle += 360;

    // 30度ごとに区切ってインデックス決定（0~11）だが行数は11なので上限処理
    let idx = Math.floor(normAngle / 30);
    if(idx >= lines.length) idx = lines.length - 1;

    if (idx !== currentIndex) {
      lineElements[currentIndex].classList.remove('active');
      lineElements[idx].classList.add('active');
      currentIndex = idx;
    }
  }

  // センサーの許可とイベント登録
  async function requestPermissionAndListen() {
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      try {
        const res = await DeviceOrientationEvent.requestPermission();
        if (res === 'granted') {
          window.addEventListener('deviceorientation', e => {
            updateLineByRotation(e.alpha || 0);
          });
        } else {
          alert('ジャイロセンサーの許可が必要です');
        }
      } catch(e) {
        alert('許可取得エラー');
      }
    } else {
      window.addEventListener('deviceorientation', e => {
        updateLineByRotation(e.alpha || 0);
      });
    }
  }

  document.body.addEventListener('click', () => {
    requestPermissionAndListen();
  }, { once: true });
</script>

</body>
</html>
